substitutions:
  name: polly-esp32
  friendly_name: Polly ESP32-S3

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  platformio_options:
    board_build.flash_mode: dio
  includes:
    - polly_websocket.h
  libraries:
    - ArduinoWebsockets

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: arduino
    version: recommended

psram:
  mode: octal
  speed: 80MHz

# WiFi Configuration
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  on_connect:
    - logger.log: "WiFi Connected!"
    - lambda: |-
        // Connect to Polly server WebSocket
        polly_websocket_connect("${polly_server_uri}");

  ap:
    ssid: "${name} Fallback"
    password: "polly12345"

logger:
  level: DEBUG

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

# I2S Audio for INMP441 Microphone
i2s_audio:
  - id: i2s_mic
    i2s_lrclk_pin: GPIO42  # WS
    i2s_bclk_pin: GPIO40   # SCK

microphone:
  - platform: i2s_audio
    id: mic
    adc_type: external
    i2s_din_pin: GPIO41    # SD
    channel: left
    sample_rate: 16000
    bits_per_sample: 32bit
    pdm: false

# microWakeWord - Wake Word Detection
micro_wake_word:
  model: okay_nabu
  probability_cutoff: 0.97
  sliding_window_average_size: 5

  on_wake_word_detected:
    - logger.log:
        format: "Wake word '%s' detected!"
        args: ['wake_word.c_str()']
    - light.turn_on:
        id: led
        red: 0%
        green: 100%
        blue: 0%
    - lambda: |-
        // Send wake_word_detected event to Polly server
        polly_websocket_send_wake_detected();
        // Start streaming audio
        id(mic).start();
    - delay: 5s  # Stream for 5 seconds
    - lambda: |-
        id(mic).stop();
        polly_websocket_send_command_end();
    - light.turn_off: led
    - micro_wake_word.start:

# Status LED
light:
  - platform: rgb
    name: "Status LED"
    id: led
    red: led_r
    green: led_g
    blue: led_b

output:
  - platform: ledc
    pin: GPIO48
    id: led_r
  - platform: ledc
    pin: GPIO47
    id: led_g
  - platform: ledc
    pin: GPIO21
    id: led_b

# Status sensors
binary_sensor:
  - platform: status
    name: "Status"

sensor:
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "IP Address"
