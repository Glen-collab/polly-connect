substitutions:
  name: polly-voice-assistant
  friendly_name: Polly Voice Assistant

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  platformio_options:
    board_build.flash_mode: dio

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf
    version: recommended
    sdkconfig_options:
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: "y"
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: "y"
      CONFIG_AUDIO_BOARD_CUSTOM: "y"

psram:
  mode: octal
  speed: 80MHz

# WiFi Configuration
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot
  ap:
    ssid: "${name} Fallback"
    password: "polly12345"

# Enable logging
logger:
  level: INFO

# Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

# OTA Updates
ota:
  - platform: esphome
    password: !secret ota_password

# I2S Audio Configuration for INMP441
i2s_audio:
  - id: i2s_in
    i2s_lrclk_pin: GPIO42  # WS pin
    i2s_bclk_pin: GPIO40   # SCK pin

# Microphone
microphone:
  - platform: i2s_audio
    id: mic
    adc_type: external
    i2s_din_pin: GPIO41    # SD pin
    channel: left
    sample_rate: 16000
    bits_per_sample: 32bit
    pdm: false

# microWakeWord - On-Device Wake Word Detection
micro_wake_word:
  models:
    - model: okay_nabu
      probability_cutoff: 0.97
      sliding_window_size: 5

  on_wake_word_detected:
    - logger.log:
        format: "Wake word detected: %s"
        args: ['wake_word.c_str()']
    - light.turn_on:
        id: led
        red: 0%
        green: 100%
        blue: 0%
        brightness: 100%
    - voice_assistant.start:
        wake_word: !lambda return wake_word;

# Voice Assistant
voice_assistant:
  id: va
  microphone: mic
  use_wake_word: false  # We use micro_wake_word instead

  on_listening:
    - logger.log: "Listening for command..."
    - light.turn_on:
        id: led
        red: 0%
        green: 0%
        blue: 100%
        brightness: 50%

  on_stt_end:
    - logger.log:
        format: "Command transcribed: %s"
        args: ['x.c_str()']

  on_end:
    - logger.log: "Voice assistant ended"
    - light.turn_off: led
    - micro_wake_word.start:

  on_error:
    - logger.log:
        format: "Voice assistant error: %s"
        args: ['code.c_str()']
    - light.turn_on:
        id: led
        red: 100%
        green: 0%
        blue: 0%
        brightness: 100%
    - delay: 1s
    - light.turn_off: led
    - micro_wake_word.start:

# Status LED (RGB)
# Adjust pins based on your board
light:
  - platform: rgb
    id: led
    name: "Status LED"
    red: led_red
    green: led_green
    blue: led_blue
    restore_mode: ALWAYS_OFF

output:
  - platform: ledc
    id: led_red
    pin: GPIO48
  - platform: ledc
    id: led_green
    pin: GPIO47
  - platform: ledc
    id: led_blue
    pin: GPIO21

# Switches
switch:
  - platform: template
    name: "Use Wake Word"
    id: use_wake_word
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    on_turn_on:
      - micro_wake_word.start:
    on_turn_off:
      - voice_assistant.stop:
      - micro_wake_word.stop:

# Status Sensors
binary_sensor:
  - platform: status
    name: "ESP32 Status"

sensor:
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

  - platform: uptime
    name: "Uptime"
    update_interval: 60s

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "IP Address"
    ssid:
      name: "Connected SSID"
